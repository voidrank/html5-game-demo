<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0, minimum-scale=1, maximum-scale=1, user-scalable=no, target-densitydpi=device-dpi;" />
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="full-screen" content="true"/>
    <meta name="screen-orientation" content="portrait"/>
    <meta name="x5-fullscreen" content="true"/>
    <meta name="360-fullscreen" content="true"/>
    <title>本食的吃货</title>
    <script src="./bower_components/easeljs/lib/easeljs-0.8.0.min.js"></script>
    <script src="./bower_components/preloadjs/dist/preloadjs-0.6.0.min.js"></script>
</head>

<body style="margin: 0px 0px 0px 0px;">
<canvas id="gameStage" style="margin: 0px 0px 0px 0px; position: absolute"></canvas>
<script>

    // screen adapt
    var canvas = document.getElementById("gameStage");
    var designWidth = 750;
    var designHeight = 1270;


    // view area
    var viewWidth = document.documentElement.clientWidth < 750 ? document.documentElement.clientWidth : 750;
    var viewHeight = document.documentElement.clientHeight;
    console.log(viewWidth, viewHeight);

    var scale = viewWidth / designWidth;

    canvas.width = viewWidth / scale;
    canvas.height = viewHeight / scale;
    canvas.style.width = viewWidth + "px";
    canvas.style.height = viewHeight + "px";

    // game
    var stage = new createjs.Stage(canvas);
    createjs.Touch.enable(stage);

    // time
    var timeTotal = 0;
    var startTime = 0;


    // pre
    goToPre = function() {

        stage.removeAllChildren();
        stage.addChild(preBackground);
        stage.addChild(enterButton);
        stage.addChild(instructionDisplay);

        state = "pre";
    };


    // init
    goToMenu = function() {

        stage.removeAllChildren();
        stage.addChild(playingBackground);
        stage.addChild(menuBackground);
        stage.addChild(startButton);
        stage.addChild(gameName);
        stage.addChild(gameIntroduction);

        state = "menu";
    };


    goToPlay = function() {

        totalPoint = 0;
        timeTotal = 0;
        startTime = (new Date()).getTime();
        refreshPointDisplay();
        refreshTime();

        stage.removeAllChildren();

        stage.addChild(playingBackground);
        stage.addChild(suspendButton);
        stage.addChild(timeDisplay);
        stage.addChild(totalPointDisplay);

        state = "playing";
    };


    goToSuspend = function() {

        for (var i = 0; i < stage.children.length; ++i) {

            // remove suspend button
            if (stage.children[i].name === "suspend") {
                stage.removeChildAt(i);
                --i;
            }

            // disable click listener to prevent user get
            // points when suspending
            else if ("name" in stage.children[i] && stage.children[i].name === "food") {
                stage.children[i].disableClick();
            }
        }

        stage.addChild(continueButton);
        stage.addChild(menuBackground);
        stage.addChild(instructionDisplay);

        state = "suspend";
    };


    goToContinue = function() {

        for (var i = 0; i < stage.children.length; ++i) {

            // remove continue button
            if ("name" in stage.children[i]&& (stage.children[i].name === "continue" || stage.children[i].name === "instruction" || stage.children[i].name === "menu-background")) {
                console.log(stage.children[i]);
                stage.removeChildAt(i);
                --i;
            }

            // enable click listener to continue
            else if ("name" in stage.children[i] && stage.children[i].name === "food"){
                stage.children[i].enableClick();
            }
        }

        stage.addChild(suspendButton);

        state = "playing";
    };


    goToFinish = function(totalScore) {
        state = "finish";
        stage.removeAllChildren();
        stage.addChild(finishBackground);
        /*
        var level;
        if (totalScore >= 120)
            level = "A";
        else if (totalScore >= 110)
            level = "A-";
        else if (totalScore >= 100)
            level = "B+";
        else if (totalScore >= 90)
            level = "B";
        else if (totalScore >= 80)
            level = "B-";
        else if (totalScore >= 70)
            level = "C+";
        else if (totalScore >= 60)
            level = "C";
        else if (totalScore >= 50)
            level = "C-"
        else if (totalScore >= 40)
            level = "D"
        else
            level = "F"
        */
        var scoreDisplay = new createjs.Text("课程编号      成绩\n NO.1             " + totalScore, "bold 70px comic sans", "#000000");
        scoreDisplay.x = 100;
        scoreDisplay.y = 450;
        stage.addChild(scoreDisplay);
        stage.addChild(resumeButton);
        stage.addChild(shareButton);
    };

    // state:
    //      menu
    //      playing
    //      suspend
    //      finish
    var state = "pre";


    // background
    var preBackground = new createjs.Bitmap("./pre-background.png");
    preBackground.name = "pre-background";

    var playingBackground = new createjs.Bitmap("./playing-background.png");
    playingBackground.name = "playing-background";

    var menuBackground = new createjs.Bitmap("./menu-background.png");
    menuBackground.name = "menu-background";

    var finishBackground = new createjs.Bitmap("./finish-background.png");
    finishBackground.name = "finishBackground";
    finishBackground.y = -50;


    // text
    var gameName = new createjs.Text("本食的吃货", "bold 70px comic sans", "#ffffff");
    gameName.x = 100;
    gameName.y = 80;
    gameName.regX = -100;
    gameName.regY = -150;
    gameName.textBaseline = "alphabetic";

    var gameIntroduction = new createjs.Text(
            "30s内点击屏幕中的旦苑食物获得相应\n分数：\n\n\n" +
            "     油炸芒果获得5分；大块肉获得3分；\n\n" +
            "     大排获得2分；辣椒倒扣2分  \n",
            "bold 40px comic sans", "#ffffff");
    gameIntroduction.x = 25;
    gameIntroduction.y = 300;

    var timeDisplay = new createjs.Text("test", "bold 70px comic sans", "#e2ff12");
    timeDisplay.x = 50;
    timeDisplay.y = 885;

    var instructionDisplay = new createjs.Text(
        "旦苑的吃货\n\n" +
        "说到复旦学子的“吃”，不得不提及本\n" +
        "食旦苑.本部食堂名为“旦苑”，紧邻\n" +
        "光华楼东主楼，是我旦学子最为熟悉\n" +
        "和喜爱的食堂之一，全覆盖WIFI，为\n" +
        "我校学子提供了极大地便利。同时，\n" +
        "各类菜品，应有尽有，永远爆满的\n" +
        "清真食堂是新增亮点，油炸芒果\n" +
        "大块肉也是旦苑的“明星产品”。\n\n" +
        "想体验在食堂吃饭的愉悦吗？\n快进入游戏填饱肚子吧~", "bold 40px comic sans", "#eeeeee");
    instructionDisplay.y = -100;

    var totalPoint = 0;
    var totalPointDisplay = new createjs.Text("总得分: 0", "bold 50px comic sans", "#eeeeee");
    totalPointDisplay.x = 500;
    totalPointDisplay.y = 900;
    stage.addChild(totalPointDisplay);

    instructionDisplay.x = 400;
    instructionDisplay.y = 800;
    instructionDisplay.regX = 350;
    instructionDisplay.regY = 600;
    instructionDisplay.name = "instruction";


    // button
    var enterButton = new createjs.Bitmap("./enter.png");
    enterButton.x = 200;
    enterButton.y = 900;
    enterButton.addEventListener("mousedown", function() {
        goToMenu();
    });

    var startButton = new createjs.Bitmap("./start.jpeg");
    startButton.x = 200;
    startButton.y = 900;
    startButton.addEventListener('mousedown', function () {
        goToPlay();
    });

    var suspendButton = new createjs.Bitmap("./suspend.jpg");
    suspendButton.name = "suspend";
    suspendButton.x = 100;
    suspendButton.y = 80;
    suspendButton.regX = 50;
    suspendButton.regY = 50;
    suspendButton.addEventListener('mousedown', function() {
        goToSuspend();
    });

    var continueButton = new createjs.Bitmap("./start.jpeg");
    continueButton.name = "continue";
    continueButton.x = 100;
    continueButton.y = 80;
    continueButton.regX = -100;
    continueButton.regY = -1000;
    continueButton.addEventListener('mousedown', function() {
        goToContinue();
    });

    var resumeButton = new createjs.Bitmap("./resume.png");
    resumeButton.name = "continue";
    resumeButton.x = 200;
    resumeButton.y = 900;
    resumeButton.addEventListener("mousedown", function() {
        goToMenu();
    });

    var shareButton = new createjs.Bitmap("./WeChatShare.png");
    shareButton.x = 250;
    shareButton.y = 850;


    // food
    var foodList = [
        new createjs.Bitmap("./油炸芒果.png"),
        new createjs.Bitmap("./大排.png"),
        new createjs.Bitmap("./大块肉.png"),
        new createjs.Bitmap("./辣椒.png"),
    ];

    foodList[0].point = 5;
    foodList[1].point = 2;
    foodList[2].point = 3;
    foodList[3].point = -5;

    // refresh function
    refreshPointDisplay = function() {
        totalPointDisplay.text = "总得分: " + totalPoint;
    };
    refreshTime = function() {
        timeDisplay.text = ~~(timeTotal / 1000);
    };


    goToPre();


    // game loop
    var nextFood = 0;
    createjs.Ticker.addEventListener("tick", function () {
        if (state === "menu") {

            // pass
        }
        if (state === "playing") {
            // move && remove food
            for (var i = 0; i < stage.children.length; ++i)
                if (stage.children[i].name === "food") {
                    if (stage.children[i].y > 1350) {
                        stage.removeChildAt(i);
                    }
                    else {
                        stage.children[i].y += stage.children[i].speed;
                    }
                }

            // next food
            nextFood -= 1;
            if (nextFood < 0) {
                nextFood = 10;

                // create a food
                ((function() {
                    var t = ~~(Math.random() * 7);
                    if (t > 3) t = 3;
                    var foodType;
                    var newFood = Object.create(foodList[t]);
                    newFood.name = "food";
                    newFood.x = 50;
                    newFood.y = 50;
                    newFood.speed = ((Math.random() * 40) + 10);
                    newFood.regX = ~~(Math.random() * 500) - 500;
                    newFood.regY = 100;
                    var that = newFood;
                    var click = function () {
                        stage.removeChild(that);
                        totalPoint += that.point;
                        refreshPointDisplay();
                    };
                    newFood.addEventListener('mousedown', click);
                    newFood.disableClick = function() {
                        that.removeEventListener('mousedown', click);
                    };
                    newFood.enableClick = function() {
                        that.addEventListener('mousedown', click);
                    };

                    // insert it to the stage
                    stage.addChild(newFood);
                })());
            }

            timeTotal += (new Date()).getTime() - startTime;

            // finish
            // finish time 30s
            if (timeTotal >= 30000) {
                goToFinish(totalPoint);
            }
        }
        else if (state === "suspend") {

            // pass
        }
        refreshTime();
        startTime = (new Date()).getTime();
        stage.update();
    });
</script>
</body>
</html>
